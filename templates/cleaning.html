{% extends "base.html" %}

{% block title %}Data Cleaning - DataClean Pro{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cleaning.css') }}">
{% endblock %}

{% block content %}
<div class="cleaning-container">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header mb-4">
            <h1 class="page-title">
                Data Cleaning Tool
            </h1>
            <p class="page-subtitle">
                Upload and clean your sales data from supported marketplaces
            </p>
        </div>

        <!-- Main Cleaning Card -->
        <div class="card cleaning-card">
            <div class="card-header">
                <h4>Data Cleaning Configuration</h4>
            </div>
            
            <div class="card-body">
                <!-- Step 1: Marketplace Selection -->
                <div class="mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-store me-2"></i>Step 1: Choose Marketplace</h5>
                        <button class="btn btn-outline-info btn-sm" id="sampleDataBtn">
                            <i class="fas fa-download me-1"></i>Download Sample Data
                        </button>
                    </div>
                    
                    <div class="marketplace-grid">
                        <div class="marketplace-card" data-marketplace="Noon">
                            <i class="fas fa-sun fa-2x text-primary"></i>
                            <h6>Noon</h6>
                        </div>
                        <div class="marketplace-card" data-marketplace="Amazon">
                            <i class="fab fa-amazon fa-2x text-primary"></i>
                            <h6>Amazon</h6>
                        </div>
                        <div class="marketplace-card" data-marketplace="Revibe">
                            <i class="fas fa-recycle fa-2x text-primary"></i>
                            <h6>Revibe</h6>
                        </div>
                        <div class="marketplace-card" data-marketplace="Talabat">
                            <i class="fas fa-motorcycle fa-2x text-primary"></i>
                            <h6>Talabat</h6>
                        </div>
                        <div class="marketplace-card" data-marketplace="Careem">
                            <i class="fas fa-car fa-2x text-primary"></i>
                            <h6>Careem</h6>
                        </div>
                    </div>
                    <input type="hidden" id="selectedMarketplace">
                </div>

                <!-- Step 2: File Upload -->
                <div class="mb-5">
                    <h5 class="mb-3"><i class="fas fa-cloud-upload-alt me-2"></i>Step 2: Upload Your Data File</h5>
                    
                    <div class="file-upload-area" id="fileDropArea">
                        <i class="fas fa-file-upload fa-3x text-primary mb-3"></i>
                        <h5 class="mb-2">Drag & Drop Your File Here</h5>
                        <p class="text-muted mb-4">or click to browse</p>
                        <button class="btn btn-outline-primary" id="browseBtn">
                            <i class="fas fa-folder-open me-2"></i>Browse Files
                        </button>
                        <input class="form-control d-none" type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                        <p class="small text-muted mt-3 mb-0">Supports CSV, Excel (.xlsx, .xls)</p>
                    </div>
                    
                    <!-- File Info -->
                    <div id="fileInfo" class="file-info-card" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-file-alt me-2"></i>Selected File</h6>
                                <div id="fileDetails" class="text-muted"></div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" id="clearFileBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="text-center">
                    <button class="btn btn-primary btn-lg px-5" id="cleanBtn" disabled>
                        <i class="fas fa-magic me-2"></i>Clean & Process Data
                    </button>
                    <div class="loader" id="loader"></div>
                </div>

                <!-- Error Display -->
                <div id="errorAlert" class="alert alert-danger d-none mt-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section mt-4">
            <div class="preview-container">
                <div class="preview-header">
                    <div>
                        <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Cleaned Data Preview</h5>
                        <small class="opacity-75">Showing all cleaned data rows</small>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <span class="badge" id="rowCountBadge" style="background: var(--primary-color); color: #000;">
                            <i class="fas fa-table me-1"></i>
                            <span id="rowCount">0 rows</span>
                        </span>
                        <button class="btn btn-success" id="downloadBtn" disabled>
                            <i class="fas fa-download me-2"></i>Download All Data
                        </button>
                    </div>
                </div>
                
                <div class="preview-content">
                    <div id="previewPlaceholder" class="empty-preview">
                        <i class="fas fa-database fa-4x mb-3"></i>
                        <h4 class="mt-3">No Data to Preview</h4>
                        <p class="text-muted">Upload and clean your data to see the preview here</p>
                    </div>
                    
                    <div id="previewContent" style="display: none;">
                        <table class="table preview-table" id="previewTable">
                            <thead id="tableHeader"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sample Data Modal -->
<div class="modal fade" id="sampleDataModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>Download Sample Data
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="sampleDataContent">
                    <div class="text-center py-4">
                        <div class="loader-small"></div>
                        <p class="text-muted mt-2">Loading sample data...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Notes Section (Preview के बाद) -->
<div class="notes-section">
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Important Information
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h6 class="text-primary mb-2">Missing Brand, Category, or Sub-Category?</h6>
                    <p class="small mb-3">
                        If you see empty values in <strong>Brand Name, Category, or Sub-Category</strong> columns, 
                        it means the SKU was not found in our product database. To fix this:
                    </p>
                    <ol class="small mb-0">
                        <li>Go to the <strong>Add Data</strong> page</li>
                        <li>Add the missing product information with correct SKU</li>
                        <li>Re-upload and clean your data file</li>
                    </ol>
                </div>
                <div class="col-md-4 text-center">
                    <a href="/add-data" class="btn btn-primary btn-lg mb-2">
                        <i class="fas fa-plus-circle me-2"></i>
                        Add Product Data
                    </a>
                    <p class="small text-muted mb-0">
                        Add missing products to master database
                    </p>
                </div>
            </div>
            
            <hr class="my-3">
            
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary mb-2">Data Cleaning Notes:</h6>
                    <ul class="small mb-0">
                        <li><strong>Month Number & Year:</strong> Displayed as integers (not floats)</li>
                        <li><strong>QTY:</strong> Always displayed as whole numbers</li>
                        <li><strong>GMV:</strong> Calculated as Sales Price × QTY</li>
                        <li><strong>Cancelled Orders:</strong> GMV set to 0 automatically</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-primary mb-2">Need Help?</h6>
                    <ul class="small mb-0">
                        <li>Check sample data format before uploading</li>
                        <li>Ensure SKU format matches exactly</li>
                        <li>For bulk uploads, use CSV template</li>
                        <li>Contact support for any issues</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/cleaning.js') }}"></script>
{% endblock %}